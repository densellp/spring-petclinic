# File: .github/workflows/deploy.yml

name: Linux_Container_Node_Workflow

on:
    push:
      branches:
        - test

permissions:
    id-token: write
    contents: read
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    strategy:
        matrix:
          java: [ '17' ]
    steps:
    - name: 'Checkout Github Action'
      uses: actions/checkout@v3

    - name: 'Az CLI login'
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: 'Run az commands'
      run: |
        az account show
        az group list
        pwd

    # - name: Log into the registry
    #   run: az acr login --name CRspringpetclinicDOB

    - name: Set up JDK ${{matrix.java}}
      uses: actions/setup-java@v2
      with:
        java-version: ${{matrix.java}}
        distribution: 'adopt'
        cache: maven

    - name: Build Spring Petclinic
      run: ./mvnw spring-boot:build-image

    - uses: azure/docker-login@v1
      with:
        login-server: crspringpetclinicdob.azurecr.io
        username: ${{ secrets.REGISTRY_USERNAME }}
        password: ${{ secrets.REGISTRY_PASSWORD }}

    - name: Retag Docker Image and Push to ACR
      run: |
        docker tag spring-petclinic:3.0.0-SNAPSHOT crspringpetclinicdob.azurecr.io/spring-petclinic:${{ github.sha }}
        docker push crspringpetclinicdob.azurecr.io/spring-petclinic:${{ github.sha }}

    # - uses: azure/webapps-deploy@v2
    #   with:
    #     app-name: 'AS-spring-petclinic-DOB'
    #     images: 'crspringpetclinicdob.azurecr.io:${{ github.sha }}'

# testing